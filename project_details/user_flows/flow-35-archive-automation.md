### Flow 35: Archive Automation

**Trigger**: User or ops admin archives automation version

**Flow Diagram**:
```
User/admin requests archive
    ↓
Validate automation_version exists
    ↓
If status = 'Live':
    Deactivate workflow in WRK Platform
    Update workflow_binding.status = 'inactive'
    ↓
Update automation_version.status = 'Archived'
    ↓
Update project.status = 'Archived' (if linked)
    ↓
Create audit log entry
    ↓
Send notifications
    ↓
Return success
```

**API Endpoints**:
- `PATCH /v1/automation-versions/{id}/status` (status='Archived')
- `DELETE /v1/automations/{id}` (soft delete, sets all versions to Archived)

**Database Changes**:
- Update `automation_versions` (status='Archived')
- Update `projects` (status='Archived')
- Update `workflow_bindings` (status='inactive' if was active)
- Insert into `audit_logs` (action_type='archive_automation')

**Notifications**:
- **Email**: Automation archived notification (template: `automation_archived`, to owner and collaborators)
- **In-app**: Notification to team

**Exceptions**:
- **Automation not found**: Return 404
- **Cannot archive Live version without replacement**: Return 400 (must have new Live version first)
- **No permission**: Return 403

**Manual Intervention**: 
- Ops admin may archive automations manually
- Client can request archive (requires approval)

---

## Summary

This document covers all major user flows in WRK Copilot, including:

- **Identity & Access**: SSO-first signup with workspace creation, invitation, login, password reset (local only), API keys, workspace switching, partner API access (optional/future)
- **Automation Lifecycle**: Create, requirements capture & AI ingestion, update blueprint, move to pricing (with auto-quote), create version, update status (with state machine including Paused state), pause/resume workflows
- **Pricing & Billing**: Auto-generate and send quote (Flow 11), ops adjust quote, client view/accept/reject, sign (with payment), volume adjustments (with credit/payment checks), overrides, billing finalization
- **Build & Deployment**: Request build, orchestration (future/v1 manual), QA (manual status changes in v1), deploy to production (manual status changes in v1), credentials management, credential failure handling
- **Execution & Monitoring**: Run event webhooks, usage aggregation, threshold alerts
- **Collaboration**: Messages (chat-like, real-time), tasks (auto-generated by system), task status updates
- **Admin & Ops**: Associate client with existing workspace (users create own accounts), update health status, archive automation

**Key Architectural Alignments**:
- **Workspace-Centric UX**: Users authenticate first, then create workspace (name + subdomain) if they don't belong to any workspace. Workspace = Tenant (1:1 mapping, no extra abstraction). Access via `https://{workspace_slug}.wrk.com/app`. Terminology: "Workspace" in UX, "tenant" in backend/DB. The first user who creates a workspace is that workspace's admin/owner. Invited users join that same workspace/tenant, they don't create new workspaces/clients.
- **SSO-First Authentication**: SSO/IdP is primary mode with minimal friction (no email verification, no password setup). If user already mapped to workspace, skip workspace creation. Local email/password is fallback with configurable verification.
- **Workspace-Scoped Invitations**: Admins invite colleagues into their current workspace. Invited users land directly in the inviting workspace.
- **Multi-Workspace Support**: Users can belong to multiple workspaces via memberships table. Workspace switcher in UX, multi-tenant logic in backend.
- **State Machine**: Automation status transitions follow strict state machine rules (see Automation Status State Machine section). Includes 'Paused' status (client-driven) vs 'Blocked' (system/ops-driven). Supports backward transitions from QA & Testing.
- **Auto-Pricing**: In v1, pricing is auto-generated and immediately sent to the client when a project is created (Flow 11). Ops can adjust existing quotes but don't originate them.
- **Project Creation Timing**: Projects created when moving from "Intake in Progress" to "Needs Pricing", not during automation creation
- **Task Creation Timing**: Build checklist tasks created when build starts or when project created for pricing, not during automation creation. Tasks are auto-generated by the system based on missing items/validation rules.
- **Manual Status Changes (v1)**: In v1, status changes for QA & Testing → Ready to Launch and Ready to Launch → Live are performed manually by ops team in admin panel, not automatic.
- **User Account Creation**: Users create their own accounts/workspaces via signup flow. Ops does not create client accounts/workspaces; ops can only associate existing workspaces with client records.
- **Audit Logging**: All user-initiated changes to system state must create audit log entries, even if not explicitly called out in each flow.
- **Tenant Isolation**: All flows enforce `tenant_id` from authenticated session (JWT or API key), never from request parameters
- **Payment Integration**: Quote signing includes payment method collection and setup fee charging. Volume adjustments check credit/payment before applying changes.
- **Credentials Security**: Credentials stored in secrets manager, only references in database

**Flow Structure**: Each flow includes Trigger, Flow Diagram, API Endpoints, Database Changes, Tenant Isolation (where relevant), Notifications, Exceptions, and Manual Intervention points.

These flows serve as the foundation for backend API design and implementation, aligned with the WRK Copilot Backend Architecture (modular monolith, Neon, workers, webhooks, HMAC, idempotency).

