### Flow 28: Usage Sync & Threshold Alerts

> **Scope**: Flow 28 now covers both usage aggregation and threshold alerting. Instead of reading every run event from WRK Copilot, we ingest periodic summaries produced by the WRK Platform engine (e.g., hourly/daily snapshots with run counts, successes/failures, cost). After persisting those aggregates, the same worker evaluates alert thresholds and sends notifications. This consolidation replaces the old Flow 28/29 split.

**Trigger**: Scheduler pulls or receives summarized usage payloads from WRK Platform (e.g., hourly REST pull or daily push)

**Flow Diagram**:
```
Scheduled job requests usage snapshot from WRK Platform (hourly/daily)
    ↓
WRK Platform responds with summarized metrics:
    { automation_version_id, tenant_id, period_start, period_end, run_count, success_count, failure_count, total_cost }
    ↓
Usage Sync Worker validates payload (tenant + automation exist, signature if push)
    ↓
Upsert usage_aggregate for (automation_version_id, period)
    - run_count, success_count, failure_count, total_cost
    - recalc derived fields (failure_rate, average_cost_per_run, etc.)
    ↓
Check configured thresholds for that automation/version/tenant:
    - Volume > committed_volume * X
    - Failure rate > Y%
    - Cost > spend target
    ↓
If a threshold breaches and an alert for that period hasn’t been sent:
    - Insert/update alerts table (de-dup per period)
    - Send notifications (email, in-app, Slack) to owners + ops/AM as needed
    ↓
Optional: publish summary audit log entry for significant usage milestones
    ↓
If period close condition met (e.g., end of month), enqueue billing/finalization job
```

**API / Integration Points**:
- **Internal pull**: Worker calls WRK Platform usage endpoint (e.g., `GET /wrk-platform/usage-summary?period=2024-07-15T00:00Z`), authenticated with service credentials.
- **Optional push**: WRK Platform can POST summarized data to a Copilot ingestion endpoint (future enhancement; not required for v1).
- No public API is exposed to customers for this flow in v1.

**Database Changes**:
- Upsert `usage_aggregates` with `{ tenant_id, automation_version_id, period_start, period_end, run_count, success_count, failure_count, total_cost, failure_rate }`. Unique constraint on `(automation_version_id, period_start, period_end)`.
- Insert/update `alerts` (or equivalent) when thresholds breach: `{ tenant_id, automation_version_id, alert_type, threshold_value, current_value, period_start, sent_at }`.
- Insert `audit_logs` (optional) for major milestones `{ action_type='usage_sync', resource_type='automation_version', metadata_json:{period_start, run_count, alert_triggered?} }`.

**Notifications**:
- Email/In-app/Slack templates for:
  - Usage overage (`usage_threshold_exceeded`)
  - Failure-rate alert (`failure_rate_threshold_exceeded`)
  - Cost overrun (`cost_threshold_alert`)
- Notifications include summary metrics (no raw run-level data) and links to dashboards.

**Exceptions & Retry Logic**:
- Missing automation or tenant: log + skip (Copilot DB may not yet know about the automation; reconciliation job handles later).
- Validation error (bad period range, negative counts): log, quarantine payload, alert ops.
- Aggregate update conflict: retry with exponential backoff.
- Alert already sent for same `(automation_version_id, alert_type, period_start)`: skip to avoid spam.
- WRK Platform API unavailable: retry per standard backoff; raise ops alert if repeated failures.

**Manual Intervention**:
- Not typical. Ops/AMs review alerts generated by this worker and may adjust thresholds via configuration.
- Billing/finance teams consume monthly aggregates downstream (Flow 20).

---
